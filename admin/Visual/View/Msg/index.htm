<!doctype html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>易迅数据分析平台</title>
    <link href="../../../res/theme/css/login.css?d=20130129v3" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="../../../res/theme/css/ligerui-grid.css" />
    <link rel="stylesheet" href="../../../res/UIlib/ligerUI-1.1.9/skins/Aqua/css/ligerui-form.css" />
    <script src="../../../res/UIlib/jquery/jquery-1.5.2.min.js" type="text/javascript"></script>
</head>

<body>
    <div id="outer_div" style="position: absolute;left: 0">
    <div id="login_page">
        <div class="tip_brow" id="notice" style="display: none">
            <div class="opcity"></div>
            <div class="inner">
                <i class="icon_warn"></i>
                <span>您当前的浏览器版本过低，请升级到ie8版本以上或使用Firefox浏览器、Chrome浏览器。</span>
            </div>
        </div>
		<div class="gw_header">
			<h1><a href="/">智网</a></h1>
			<ul class="gw_nav_list">
			  <li><a href="mailto:dihe@tencent.com?subject=智网权限申请" title="账号申请">账号申请{$name}</a></li>
			  <li><a href="mailto:dihe@tencent.com?subject=问题及建议反馈" title="联系管理员">联系管理员</a></li>
			  <li><a href="http://mandyzhou.thinkphp.com/biz/admin/web/help/index.htm" onclick="login.openHelpPage();return false" title="帮助中心">帮助中心</a></li>
			</ul>
		</div>
        <div class="banner" id="banner">
            <div class="banner_cont" id="banner_img">
                <ul>
                    <li class="li1"></li>
                    <li class="li2"></li>
                </ul>
            </div>
            <ul class="banner_nu" id="banner_btn">
                <li class="status_on"><a href="javascript:;">1</a></li>
                <li><a href="javascript:;">2</a></li>
            </ul>
        </div>

        <script>
            var login = {}; //命名空间

            //获取url参数
            login.getQuery = function(name,url){
                var u  = arguments[1] || window.location.search,
                reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)"),
                r = u.substr(u.indexOf("\?")+1).match(reg);
                return r!=null?r[2]:"";
            }

            //读取cookie
            login.getCookie = function(name) {
                var reg = new RegExp("(^| )" + name + "(?:=([^;]*))?(;|$)"), val = document.cookie.match(reg);
                return val ? (val[2] ? unescape(val[2]) : "") : null;
            };

            //设置cookie
            login.setCookie = function( name, value, expires, path, domain, secure ) {
                var today = new Date();
                today.setTime( today.getTime() );
                if ( expires ) {
                    expires = expires * 1000 * 60 * 60 * 24;
                }
                var expires_date = new Date( today.getTime() + (expires) );
                document.cookie = name+'='+escape( value ) +
                ( ( expires ) ? ';expires='+expires_date.toGMTString() : '' ) + //expires.toGMTString()
                ( ( path ) ? ';path=' + path : '' ) +
                ( ( domain ) ? ';domain=' + domain : '' ) +
                ( ( secure ) ? ';secure' : '' );
            };

            //删除cookie
            login.deleteCookie = function(name, path, domain){
                if ( login.getCookie( name ) )
                {
                    document.cookie = name + '=' +
                    ( ( path ) ? ';path=' + path : '') +
                    ( ( domain ) ? ';domain=' + domain : '' ) +
                    ';expires=Thu, 01-Jan-1970 00:00:01 GMT';
                }
            };

            login.checkSessionId = function(sid) {
                var sid = sid || login.getQuery('session') || login.getCookie('loginkey');		//第三方单点登录
                if(sid){
                    $.ajax({
                        type : 'POST',
                        url : 'http://mandyzhou.thinkphp.com/json.php?mod=CheckUser&act=checkSession',
                        data : '&sid=' + sid,
                        dataType : 'json',
                        success: function(rdata) {
                            if(rdata.status){
                                location.href = 'http://mandyzhou.thinkphp.com/admin/main.htm';
                                }else{
                                console.log(rdata.msg);
                            }
                        },
                        error: function() {
                            alert("session校验接口调用失败");
                        }
                    });
                } else if(login.getCookie("username")&&login.getCookie('id_hash')) {    //直接在智网平台登录
                    $.ajax({
                        url: 'http://mandyzhou.thinkphp.com/json.php?mod=SecureCookie&act=islogin',
                        cache: false,
                        success: function(para){
                            if(para=='true')
                            {
                                location.href = 'http://mandyzhou.thinkphp.com/admin/main.htm';
                            }
                        }
                    });

                }
            };

			//帮助页面弹窗
			login.openHelpPage = function(){
				var url = "http://mandyzhou.thinkphp.com/biz/admin/web/help/index.htm";
				window.open(url, '','toolbar=0,location=0,directories=0,status=0,menubar=0,scrollbars=1,resizable=0,width=920,height=560').focus();
				return false;
			};
            login.checkSessionId();

            if(login.getCookie("check")){     //新开页面时清除检查验证码
                login.deleteCookie("check", "/", "");
            }
        </script>

        <div class="wrap_login">
            <div class="inner">
                <div class="login">
                    <h2>欢迎使用智网系统</h2>
                    <div class="login_form">
                        <form id="form1" name="form1" method="post">
                            <ul>
                                <li class="name"><span class="hd name_hd"></span><input tabIndex="1" type="text" id="username" name="username" class="txt_normal form_name" value="用户名"></li>
                                <li class="password">
                                <span class="hd password_hd"></span>
                                <span id="psw_text" class="ext">密码</span>
                                <input tabIndex="2" type="text" id="password" name="userpwd" class="txt_normal" value="">
                                </li>
                                <li class="valida" id="valida" style="display: none"><a class="wrap_img" href="javascript:;"><img width="90" height="30" class="img" id="validateimg" src="http://mandyzhou.thinkphp.com/biz/admin/web/vcode.php" onclick="login.change();" alt="验证码" /></a><input tabIndex="3" name="userimg" id="userimg" type="text" class="txt_mini" value="验证码" /></li>
                                <li class="reman"><a class="todo_link"  href="mailto:cookiezhong@tencent.com">忘记密码请联系管理员</a><span class="remanber"><input tabIndex="4" id="id" value="1" type="checkbox"  class="chk" /><label for="id">记住我</label></span></li>
                            </ul>
                            <a href="javascript:;" id="login_btn" class="login_btn" onclick="return login.which_login();"></a>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="intr clearfix">
            <div class="intro">
                <ul>
                    <li class="fun"><a href="javascript:;" onclick="login.sliderToOtherPage('productFeatures')" style="cursor:pointer"><i class="icon"></i>产品功能</a></li>
                    <li class="action"><a href="javascript:;" onclick="login.sliderToOtherPage('flowline')" style="cursor:pointer"><i class="icon"></i>产品动线</a></li>
                    <li class="team"><a href="javascript:;" onclick="login.sliderToOtherPage('team')" style="cursor: pointer"><i class="icon"></i>智网团队</a></li>
                </ul>
            </div>
            <div class="download" id="download">
                <h3>建议您安装以下浏览器浏览智网</h3>
                <div class="chrome"><a href="http://www.google.cn/intl/zh-CN/chrome/browser/" target="_blank"><span class="icon"></span><p>谷歌浏览器 <i></i></p></a></div>
                <div class="firefox"><a href="http://download.firefox.com.cn/releases/webins3.0/official/zh-CN/Firefox-latest.exe"><span class="icon"></span><p>火狐浏览器 <i></i></p></a></div>
            </div>
        </div>
        <div class="footer">
            ECC业务经营分析部
            <span class="splite">|</span>
            <span class="ecd"></span>
            <span class="splite">|</span>
            Copyright &copy; 2012 - 2013 Tencent. All Rights Reserved
        </div>
    </div>
    <!--<div id="other_page" style="position: fixed; top: 0px; height: 1px; width: 1px; left: -1px">
        <iframe onload="login.backLoginPage()" frameborder="0" width="0" height="0" name="other" src="http://mandyzhou.thinkphp.com/" id="other_page_iframe"></iframe>
    </div>-->
    </div>

    <script type="text/javascript">
	
        //密码或用户名错误次数
        login.loginErrorNum = 0;
        //用户名input默认文字
        login.defaultUserName = "用户名";
        //验证码input默认文字
        login.defaultValidate = "验证码";

        //初始化
        login.init = function(){
            //登录页轮播
            login.slider();
            //页面宽度适应及浏览器提示
            login.pageAdjust();
            //显示用户名
            login.showUserName();
            //取消“记住帐号”
            login.cancleRemember();
            //回车事件
            login.enterEvent();
            //登录框focus事件
            login.inputFocusEvent();
            //download效果
            login.downloadFadeEvent();
        };

        //登录页轮播

        login.slider = function(){
            var t = 0;
            var count;
            var show_index = 0;
            count = $("#banner_img li").length;
            $("#banner_img li:not(:first-child)").hide();

            $("#banner_btn li").click(function() {
                var i = $(this).text() - 1;  //获取Li元素内的值，即1，2...
                if (i >= count){
                    return;
                }
                var imgs = $("#banner_img li");
                imgs.eq(show_index).fadeOut(500);
                imgs.eq(i).fadeIn(1000);
                $(this).toggleClass("status_on");
                $(this).siblings().removeAttr("class");
                show_index = i ;
            });
            t = setInterval(showAuto, 4000);
            $(".banner").hover(
                function(){
                    clearInterval(t)
                },
                function(){
                    t = setInterval(showAuto, 4000);
                });

                function showAuto()
                {
                    var index = show_index >= (count - 1) ? 0 : ++show_index;
                    $("#banner_btn li").eq(index).trigger('click');
                };
        };

        //页面宽度适应及浏览器提示
        login.pageAdjust = function(){
            $(document).ready(function(){
                (function(w){
                    if(w.screen.availWidth>=1400){
                        document.body.className = 'wrap_1400';
                    }
                })(window);
                re_size();
                //ie8及ie8以下浏览器提示升级或更换浏览器
                if($.browser.msie && parseInt($.browser.version)<9){
                    $("#notice").show();
                }
                var h = $(window).height();
                $("body").css("height", h);
                $("#login_page").css("height", h);
                $("#login_page").css("width", $(window).width());
            });
            function re_size(){
                $("#login_bg").height($(document).height());
            }
            window.onresize = re_size;
        };

        //更换验证码
        login.change = function(){
            document.getElementById('validateimg').src = 'http://mandyzhou.thinkphp.com/biz/admin/web/vcode.php?'+Math.random();
        }

        //回车事件
        login.enterEvent = function(){
            $(document).bind("keydown", function(e){
                var e = e || window.event;
                if(e.keyCode == 13){     //回车事件
                    var uname = $.trim($("#username").val());
                    var psw = $("#real_pwd") && $.trim($("#real_pwd").val());
                    if(uname && psw){
                        $("#login_btn").trigger("click");
                    }
                }
            })
        };

        //登录框focus事件
        login.inputFocusEvent = function(){
            //用户名
            $("#username").focus(function(){
                if($(this).val() == login.defaultUserName){
                    $(this).val("");
                }
                $(this).parents("li").addClass("focus");
            }).blur(function(){
                $(this).parents("li").removeClass("focus");
                if($.trim($(this).val()) == ""){
                    $(this).val(login.defaultUserName);
                }
            });

            //密码
            $(".password").click(function(){
                $("#password").trigger("focus");
                if($("#real_pwd")){
                    $("#real_pwd").trigger("focus");
                }
            });
            $("#password").focus(function(){
                $(this).remove();
                //  $("#psw_text").hide();
                $(".password").append('<input tabIndex="2" type="password" id="real_pwd" name="userpwd" class="txt_normal" value="">');
                $("#real_pwd").focus(function(){
                    $(this).parents("li").addClass("focus");
                    $("#psw_text").hide();
                }).blur(function(){
                    if($(this).val() != ""){
                        $("#psw_text").hide();
                    }else{
                        $("#psw_text").show();
                    }
                    $(this).parents("li").removeClass("focus");
                });
                $("#real_pwd").trigger("focus");
            });

            //验证码
            $("#userimg").focus(function(){
                if($(this).val() == login.defaultValidate){
                    $(this).val("");
                }
            }).blur(function(){
                if($.trim($(this).val()) == ""){
                    $(this).val(login.defaultValidate);
                }
            });
        };

        //登录
        login.which_login = function(){
            var normal_action = "http://mandyzhou.thinkphp.com/Message/Msg/login";  //普通登录
            var icson_action = "http://mandyzhou.thinkphp.com/json.php?mod=CheckUser&act=Icsonlogin";  //员工登录
            var v = $("#form1 input[name='login_radio']:checked").val();
            var uname = $.trim($("#username").val());
            var psw = $.trim($("#real_pwd").val());
            if(uname == "" && psw == ""){
                alert("请填写用户名和密码！");
                return ;
            }
            if(uname == ""){
                alert("请填写用户名！");
                return ;
            }
            if(psw == ""){
                alert("请输入密码！");
                return ;
            }
            var data = $("#form1").serialize();
            $.ajax({
                type : 'POST',
                url : (v == 2) ? icson_action : normal_action,
                dataType : 'json',
                data : data,
                success: function(rdata) {
                    /*if(rdata.status){
                        login.setRemember();
                        if(rdata.sessionId){
                            var link = new Image();
                            link.src = "http://login.icson.com/Account/Authenticate?ReturnUrl=http://admin.icsion.com/login.php&session=" + rdata.sessionId;
                            login.checkSessionId(rdata.sessionId);
                        }else{
                            var redirect_url = login.getQuery("redirect_url");
                            if(redirect_url){
                                location.href = "http://mandyzhou.thinkphp.com/admin/main.htm?redirect_url=" + redirect_url;
                            }else{
                                location.href = "http://mandyzhou.thinkphp.com/admin/main.htm";
                            }
                        }
                    }else{
                        login.loginErrorNum++ ;
                        if(login.loginErrorNum >= 3){
                            $("#valida").css("display", "block");
                            if(!login.getCookie("check")){
                                login.setCookie("check", true, 0, "/", "", 0);
                            }
                        }
                        login.change();
                        alert(rdata.msg);
                    }*/
                },
                error: function() {
                    alert("权限检查失败，请联系管理员，谢谢！");
                }
            });
            return false;
        };

        //用户如果选择了记住帐号，则显示用户名并勾选“记住帐号”
        login.showUserName = function(){
            var name = login.getCookie("username");
            if(login.getCookie("remember") && name){
                $("#username").attr("value", name);
                $("#id").attr("checked", true);
            }
        };

        //如果用户选择了“记住帐号的勾选”，则设置cookie['remember']
        login.setRemember = function(){
            if($("#id").attr("checked")){
                login.setCookie("remember", true, 1, "/", "", 0);
            }
        };

        //如果用户取消了“记住帐号的勾选”，则清除cookie['remember']
        login.cancleRemember = function(){
            var obj = $("#id");
            obj.click(
                function(){
                    if(false == obj.attr("checked")){
                        login.deleteCookie("remember", "/", "");
                        login.deleteCookie("username", "/", "");
                    }
                }
            );
        };

        //download效果
        login.downloadFadeEvent = function(){
            $("#download").find("a").each(function(){
                $(this).hover(function(){
                    $(this).animate({ opacity: 1 });
                });
            });
        };

        //切换到其他页面
        login.sliderToOtherPage = function(name){
            var pDiv = $("#login_page");
            var oDiv = $("#other_page");
            var w = $(window).width();
            var h = $(window).height();
            var f = $("#other_page_iframe");
            var url = "http://mandyzhou.thinkphp.com/biz/admin/web/" + name + ".htm";

            f.attr("src", url);
            f.attr("width", w);
            f.attr("height", (h - 5));
            oDiv.css("height", h);
            oDiv.css("width", w);
            oDiv.css("left", w);
            $("body").css("overflow-x", "hidden");
            oDiv.show();
            $("#outer_div").animate({literal}{left:"-=" + w + "px"} ,{queue:false,complete:function(){
                $("body").css("overflow-y", "hidden");
                f.attr("width", $(window).width());
                $("#banner").hide();
                f.focus();
            }});
            oDiv.animate({left: "0px"});{/literal}
        };

        //返回登录页
        login.backLoginPage = function(){
            var btn = $("#other_page_iframe").contents().find("#back_login").eq(0);
            var pDiv = $("#login_page");
            var oDiv = $("#other_page");
            var w = $(window).width();
            var h = $(window).height();
            btn.click(function(){
                $("#banner").show();
                $("#outer_div").animate({literal}{left: "0px"} ,{queue:false,complete:function(){
                    $("body").css("overflow-y", "auto");
                    oDiv.hide();
                    $("body").css("overflow-x", "hidden");
                }});
                oDiv.animate({left:"+=" + w + "px"});
                pDiv.animate({left: "0px"}, function(){
                    pDiv.css("width", w);
                });
            });{/literal}
        };

        login.init();

    </script>
</body>
</html>
