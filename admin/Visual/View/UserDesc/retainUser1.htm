<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf8">
<title>新用户自定义留存</title>
{include file="$menu_path/common_css.htm"}
{include file="$menu_path/common_js.htm"}

<link rel="stylesheet" type="text/css" media="all" href="/admin.css" />
<link rel="stylesheet" type="text/css" media="all" href="/res/JqueryUI/jquery-ui.min.css" />
<link href="/res/websrc/css/index.css" rel="stylesheet" type="text/css" />
<script src="/res/websrc/UIlib/jquery/jquery-1.5.2.min.js" type="text/javascript"></script>
<script type="text/javascript" src="/res/JqueryUI/jquery-ui.min.js"></script>
<script src="/res/websrc/UIlib/jquery/common.js" type="text/javascript"></script>

<script src="/res/websrc/UIlib/highcharts/highcharts-4.0.3.js" type="text/javascript"></script>
<script src="/res/websrc/UIlib/highcharts/modules/exporting.js"></script>
{include file="$menu_path/ligerui_css.htm"}
{include file="$menu_path/ligerui_js.htm"}

<style type="text/css">
#table_show_options_sum span { width:150px;display: inline-block;}
#table_show_options_details span { /*width:150px;*/display: inline-block;} 
#table_filter_div span { width:190px;display: inline-block;} 
#show_item_div span { width:190px;display: inline-block;} 
</style>

</head>
<body>
{include file="$menu_path/menu.htm"}
<div id="left">
	<div id="userinfo">
		<span id='userName'></span>
	</div>
	<nav>
		{include file="$menu_path/menu.htm"}
	</nav>
</div>
<div class="main" id="main_body">
	<header>
		<label>选取时间段：<input type="text" name='pub_date' id="bgn_date" value=""/>至
							<input type="text" name='pub_date' id="end_date" value="" />
		</label>
		<label><a id="time_btn_1">7天</a></label>
		<label><a id="time_btn_2">14天</a></label>
		<label><a id="time_btn_3">30天</a></label>
		<label><button id="btn_search">搜 索</button></label>
	</header>
	<hr />
	<div id="content">
		
		<!-- Start 活跃用户折线图 -->
		<!-- <div class="mod_list" id="page_sum_table"> -->
		<div id="page_sum_table">
	        <h3 class="title" id="filter_desc_table">关键指标数据<span id="date_desc_table" class="sub_tit"></span></h3>
			<div id="block_title"></div>
	    	
			<div class="filter filter3" id="table_detail">
				<div class="filter_inner">
					<div>
						<div id="table_show_options_div" class="sel_item">
							<span style="width:640px;"><select name="zhibiao" id="mix_user_time" style="width:120px;margin-left:10px;">
								<option value="1">留存用户、新用户</option>
								<option value="2">留存率</option>
								<!-- <option value="3">MAU</option> -->
							</select></span>
						</div>
					</div>
				</div>
			</div>
		    <!-- <div class="mod_list_bd" style="margin-top:5px;"> -->
		    <!--留存用户、新用户-->
		    <div>
		        <div id="stats_content_detail" class="block_content center" style="width:1200px;height:450px;margin-left:50px;"></div>
		    </div>
		    <!--留存率-->
		    <div>
		        <div id="stats_content_rate" class="block_content center" style="width:1200px;height:450px;margin-left:50px;display: none;"></div>
		    </div>
		</div>
		<!-- End 活跃用户折线图 -->

		<!-- Begin 按天分布的用户数据-->
		<div id="summary_table">
			<div>
		        <!-- <div id="stats_user_detail" class="block_content center" ></div> -->
		        <div id="stats_user_detail"></div>
		    </div>
		</div>
		<!-- End 按天分布的用户数据-->
		
		<!--指标解释 S-->
		<!-- <div id="terms_definition_div" class="mod_list id_intr">
		    <h3 class="title">指标解释</h3>
			<p><strong>活跃用户: </strong>登录用户 - 新增用户</p>
			<p><strong>新增用户: </strong>相较于前一天增长的用户数</p>
			<p><strong>启动次数：</strong>用户打开APP的次数（不去重）</p>
		</div> -->
		<!--指标解释 E-->
	</div>
</div>
<script>
{literal}
$(document).ready(function(){
	
var retainDefined = {};

// var type = 1; //全局变量

//调用接口
retainDefined.cgi = {
	"mixData" : "/Visual/UserDesc/userRetainSelfdefined",
	"mixRate" : "/Visual/UserDesc/userRetainRate",
	"mixTable" : "/Visual/UserDesc/userRetainTable",
};

function getDateStr(addDayCnt)
{
	var dd = new Date();
	dd.setDate(dd.getDate() + addDayCnt);
	var y = dd.getFullYear();
	var m = dd.getMonth() + 1;
	var d = dd.getDate();
	if(m < 10)
		m = '0' + m;
	if(d < 10)
		d = '0' + d;
	return y + '-' + m + '-' + d;
}

retainDefined.actionHtml = function (){
	// 默认显示7天的数据
	$("#bgn_date").val(getDateStr(-6));
	$("#end_date").val(getDateStr(0));
	
	$("#mix_user_time").change(retainDefined.getMixUser);
}

retainDefined.init = function (){
	$("#bgn_date").datepicker({
		dateFormat: "yy-mm-dd"
	});
	$("#end_date").datepicker({
		dateFormat: 'yy-mm-dd'
	});
	// 搜索按钮点击
	$("#btn_search").click(function(){
		var check_re = retainDefined.checkDate();
		if(check_re)
		{
			// console.log('upload');
			retainDefined.getMixUser();
			retainDefined.getDetailInfo();
		}
		
	});

	$("#time_btn_1").click(function(){
		var myDate = new Date();
		$("#bgn_date").val(getDateStr(-6));
		$("#end_date").val(getDateStr(0));
	});

	$("#time_btn_2").click(function(){
		var myDate = new Date();
		$("#bgn_date").val(getDateStr(-13));
		$("#end_date").val(getDateStr(0));
	});

	$("#time_btn_3").click(function(){
		var myDate = new Date();
		$("#bgn_date").val(getDateStr(-29));
		$("#end_date").val(getDateStr(0));
	});

	retainDefined.actionHtml();
	retainDefined.getMixUser();
	retainDefined.getDetailInfo();
}

// 验证时间的合法性
retainDefined.checkDate = function(){
	var bgn = $("#bgn_date").val();
	var end = $("#end_date").val();
	// console.log(bgn);
	// console.log(end);
	if(bgn == '' || end == '' || bgn >= end)
	{
		alert("请选择合法的时间范围");
		return false;
	}
	else
		return true;
		
}

// 表头
retainDefined.header = [
	{
		display: '时间',
		name: 'datestamp',
		width: '25%',
		isSort: true,
		align: 'center',
		issortshow: true
	},
	{
		display: '留存用户',
		name: 'retain_user',
		width: '25%',
		type: 'int',
		isSort: true,
		align: 'center',
		render:  window.G.common.formatInt,
		issortshow: true
	},
	{
		display: '新增用户',
		name: 'new_user',
		width: '25%',
		type: 'int',
		isSort: true,
		align: 'center',
		render:  window.G.common.formatInt,
		issortshow: true
	},
	{
		display: '留存率',
		name: 'retain_rate',
		width: '25%',
		isSort: true,
		align: 'center',
		issortshow: true
	},
];



var gridManager = $("#stats_user_detail").ligerGrid({
	url: retainDefined.cgi.mixTable,
	pageParmName: 'current_page',
	pagesizeParmName: 'page_size',
	sortnameParmName: 'sort_name',
	sortorderParmName: 'sort_order',
	dataAction: 'server',
	dataType: 'json',
	root: 'data',
	record: 'total',
	method: 'post',
	pageSize: 30,
	pageSizeOptions: [10, 20, 30, 50],
	delayLoad: true,
	onLoading: function() {
		//$.ligerDialog.waitting('根据数据量情况,加载时间不定,请稍等...');
	},
	onAfterShowData: function() {
		//$.ligerDialog.closeWaitting();
	},
});


// 获取table中数据
retainDefined.getDetailInfo = function(){
	var params = {};
	// params['type'] = $("#detail_dimension").val();
	// 获取参数
	// params['type'] = type;
	params['bgn_date'] = $("#bgn_date").val();
	params['end_date'] = $("#end_date").val();
	// params['bgn_date'] = '2015-09-10';
	// params['end_date'] = '2015-09-21';
	gridManager.setOptions({columns: retainDefined.header});
	gridManager.setOptions({parms: params});
	gridManager.loadData();
}


//留存用户、新用户 || 留存率
retainDefined.getMixUser = function(){
	// console.log("change");
	var params = {};
	var type = $("#mix_user_time").val();
	// params['type'] = type; 
	params['bgn_date'] = $("#bgn_date").val();
	params['end_date'] = $("#end_date").val();
	// console.log(type);
	// params['bgn_date'] = '2015-09-10';
	// params['end_date'] = '2015-09-21';
	if(type == 1) //留存用户 新用户
	{
		$.ajax({
			type : 'POST',
			url : retainDefined.cgi.mixData,
			dataType : 'json',
			data: '&' + window.G.common.jsonToUrl(params),
			success: function(rdata) {
				if(rdata.code == 1){
					var data = rdata.data;
					//visiable 设置
					$("#stats_content_detail").css("display","block");
					$("#stats_content_rate").css("display","none");
					showTimeLines_detail(data, 'stats_content_detail');
				}
			}
		});
	}
	else //留存率
	{
		$.ajax({
			type : 'POST',
			url : retainDefined.cgi.mixRate,
			dataType : 'json',
			data: '&' + window.G.common.jsonToUrl(params),
			success: function(rdata) {
				// console.log(rdata);
				if(rdata.code == 1){
					var data = rdata.data;
					$("#stats_content_detail").css("display","none");
					$("#stats_content_rate").css("display","block");
					showTimeLines_rate(data, 'stats_content_rate');
				}
			}
		});
	}
	
}

function showTimeLines_rate(data, oDiv){
	console.log('function show');
	if(!data){
		return;
	}

	var d1=[], s_date=[];
	var style_type = 'line';
	var series = [];
	var data = window.G.common.listSortBy(data, 'datestamp', 'asc');

	for(var i in data){
		s_date.push(data[i].datestamp);
		d1.push(parseInt(data[i].retain_rate));
	}

	var start_item = {
			name: '留存率(%)',
			type:style_type,
			data: d1
		};
	series.push(start_item);

	retainDefined.newHighCharts(oDiv, s_date, series);	
}


function showTimeLines_detail(data, oDiv){
	if(!data){
		return;
	}

	var d1=[], d2=[], s_date=[];
	var style_type = 'line';
	var series = [];
	var data = window.G.common.listSortBy(data, 'datestamp', 'asc');

	for(var i in data){
		s_date.push(data[i].datestamp);
		d1.push(parseInt(data[i].new_user));
		d2.push(parseInt(data[i].retain_user));
	}

	var start_item = {
			name: '新用户',
			type:style_type,
			data: d1
		};
	
	series.push(start_item);

	var second_item = {
		name: '留存用户',
		type:style_type,
		data: d2
	}
	series.push(second_item);

	retainDefined.newHighCharts(oDiv, s_date, series);
}


retainDefined.newHighCharts = function(oDiv, s_date, series){
	var chart1 = new Highcharts.Chart({
		title:{
			text:"",
			align:"center",
			style:{
				color: '#b5b5b9',
				fontSize:'14px'
			}
		},
		credits:{
			enabled:false
		},
		chart:{
			renderTo: oDiv,
			style: {
				fontFamily: '"Lucida Grande", "Lucida Sans Unicode","microsoft yahei",Verdana, Arial, Helvetica, sans-serif', 
				fontSize: '12px'
			},
			marginRight:100,
			marginTop:60,
			marginLeft:150
		},
		xAxis:{
			categories: s_date,
            lineColor:'#e5e5e5',
            tickColor:'#e5e5e5',
            labels:{
            	style:{
            		color:'#7a7a7a',
            	},
            },
            tickPosition:'inside',
            tickLength:4,
            tickmarkPlacement:'on',
			tickInterval: 1
		},
		yAxis:[{
			labels:{
				format:'{value}',
				formatter: function(){
					return window.G.common.formatInt(0,0,this.value);
				},
				style:{
					color:'#f6505c'
				}
			},
			title:{
				enabled:false
			},
			min: 0
		}],
		legend:{
			align:'center',
			verticalAlign:'top',
			borderWidth:0,
			x:380,
			itemStyle:{
				fontWeight:'normal',
				color:'#a1a8b4'
			},
			itemHoverStyle: {
				color: '#c9c9c9'
			}
		},
		tooltip:{
			shared:false
		},
		series: series,
		plotOptions:{
			line:{
				marker:{
					fillColor: '#FFFFFF',
                    lineWidth: 2,
                    lineColor: null,
                    symbol: 'circle'
				}
			}
		},
		exporting:{
			enabled:false
		}
	})
}


retainDefined.init();

});
{/literal}
</script>
</body>
</html>
			
			
					