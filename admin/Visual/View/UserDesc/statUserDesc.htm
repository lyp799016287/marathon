<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf8">
<title>用户分析</title>
{include file="$menu_path/common_css.htm"}
<link rel="stylesheet" type="text/css" media="all" href="/admin.css" />
<link href="/res/websrc/css/index.css" rel="stylesheet" type="text/css" />
<script src="/res/websrc/UIlib/jquery/jquery-1.5.2.min.js" type="text/javascript"></script>
{include file="$menu_path/common_js.htm"}
<script src="/res/websrc/UIlib/highcharts/highcharts-4.0.3.js" type="text/javascript"></script>
<script src="/res/websrc/UIlib/highcharts/highcharts-3d.js" type="text/javascript"></script>
<script src="/res/websrc/UIlib/jquery/common.js" type="text/javascript"></script>
<script src="/res/websrc/UIlib/highcharts/modules/exporting.js"></script>
<style type="text/css">
#table_show_options_sum span { width:150px;display: inline-block;}
#table_show_options_details span { /*width:150px;*/display: inline-block;} 
#table_filter_div span { width:190px;display: inline-block;} 
#show_item_div span { width:190px;display: inline-block;} 
</style>
</head>
<body>
{include file="$menu_path/menu.htm"}
<div class="main" id="main_body">
	<div class="content">
		<!-- Begin 区域图 -->
		<div class="mod_list" id="retain_graph">
			<!-- <div class="mod_list_hd org_l"> -->
			<div class="org_l">
			<div class="hd">
				<h3 class="title" id="retain_title">用户留存率<span id="date_desc_graph" class="sub_tit"></span></h3>
			</div>
			</div>
			<div class="filter filter3" id="graph_top">
				<div class="filter_inner">
					<div class="sel_item" id="show_item_div">
						<span style="width:640px;">展示区间:
							<select name="time_selector" id="time_dimension" style="width:120px;margin-left:10px;">
								<option value="1">最近7天</option>
								<option value="2">最近30天</option>
							</select>
						</span>
					</div>
				</div>
			</div>
			<!-- <div class="mod_list_bd l-panel-bwarp"> -->
			<div class="l-panel-bwarp">
				<div id="retainContainer" style="min-width:700px;height:400px"></div>
			</div>
		</div>
		<!-- End 区域图 -->

		<!-- Begin 用户设备饼图 -->
		<div class="mod_list">
			<div style="width:1500px;height:400px">
				<div style="width:400px;float:left;margin-left:20px;">
					<div id="appContainer" style="width:350px;height:400px"></div>
				</div>
				<div style="width:400px;float:left;margin-left:20px;">
					<div id="sysContainer" style="width:350px;height:400px"></div>
				</div>
				<div style="width:400px;float:left;">
					<div id="sdkContainer" style="width:350px;height:400px"></div>
				</div>
			</div>
		</div>
		<!-- <hr class="clear" style="width:1500px;height:1px"/> -->
		<!-- End 用户设备饼图 -->

		<!-- Start 走势图 -->
		<div class="mod_list" id="page_sum_table">
	        <h3 class="title" id="filter_desc_table">24小时内用户登录APP走势图
	        	<span id="date_desc_table" class="sub_tit"></span>
	        </h3>
			<div id="block_title"></div>

		    <!-- <div class="mod_list_bd" style="margin-top:5px;"> -->
		    <div>
		        <div id="stats_content_detail" class="block_content center" style="width:1200px;height:450px;margin-left:50px;"></div>
		    </div>
		</div>
		<!-- End 走势图 -->
		
		<!--指标解释 S-->
		<div id="terms_definition_div" class="mod_list id_intr">
		    <h3 class="title">指标解释</h3>
		    <p><strong>留存用户数: </strong>某个时间段内新增的用户数，经过一段时间，仍使用APP的用户。该指标用来描述用户的粘性及忠诚度</p>
			<p><strong>登录用户数*: </strong>累计到前一天24:00登录用户数</p>


		</div>
		<!--指标解释 E-->
	</div>
</div>
<script>
{literal}
$(document).ready(function(){
	
var statUserDesc = {};

//调用接口
statUserDesc.cgi = {

	"usertimeData" : "/visual/userDesc/userTime",
	"sdkData" : "/visual/userDesc/userSdk",
	"sysVersionData" : "/visual/userDesc/userSysVersion",
	"appVerisonData" : "/visual/userDesc/userAppVersion",
	"userRetainData" : "/visual/userDesc/userRetain",
};

statUserDesc.actionHtml = function (){
	$("#time_dimension").change(statUserDesc.getUserRetain);
	// $("#mix_user_time").change(statUser.getMixUser);
}

statUserDesc.init = function (){

	statUserDesc.actionHtml();

	statUserDesc.getUserTime();
	statUserDesc.getAppVersion();
	statUserDesc.getSysVersion();
	statUserDesc.getSdkVersion();
	statUserDesc.getUserRetain();
}

//获取用户留存率
statUserDesc.getUserRetain = function(){
	$.ajax({
		type : 'POST',
		url : statUserDesc.cgi.userRetainData,
		dataType : 'json',
		success: function(rdata){
			if(rdata.code == 1){
				var data = rdata.data;
				showArea(data, 'retainContainer');
			}
		}
	});
}

//获取用户24小时的活跃人数
statUserDesc.getUserTime = function(){
	// var params = {};
	// params['type'] = $("#mix_user_time").val();

	$.ajax({
		type : 'POST',
		url : statUserDesc.cgi.usertimeData,
		dataType : 'json',
		// data: '&' + window.G.common.jsonToUrl(params),
		success: function(rdata) {
			// console.log(rdata);
			if(rdata.code == 1){
				var data = rdata.data;
				showTimeLines(data, 'stats_content_detail');
			}
		}
	});
}

// 用户使用APP的版本分布情况
statUserDesc.getAppVersion = function(){
	$.ajax({
		type: 'POST',
		url : statUserDesc.cgi.appVerisonData,
		dataType : 'json',
		success : function(data){
			if(data.code == 1){
				// console.log(data.data);
				var data = data.data;
				var title = '用户使用医道APP的版本分布';
				showPie(data, 'appContainer', title);
			}
		}
	});
}

// 用户手机系统版本分布情况
statUserDesc.getSysVersion = function(){
	$.ajax({
		type: 'POST',
		url : statUserDesc.cgi.sysVersionData,
		dataType : 'json',
		success : function(data){
			if(data.code == 1){
				// console.log(data.data);
				var data = data.data;
				var title = '用户手机系统的版本分布';
				showPie(data, 'sysContainer', title);
			}
		}
	});
}

// 用户的SDK分布情况
statUserDesc.getSdkVersion = function(){
	$.ajax({
		type: 'POST',
		url : statUserDesc.cgi.sdkData,
		dataType : 'json',
		success : function(data){
			if(data.code == 1){
				// console.log(data.data);
				var data = data.data;
				var title = '用户SDK的版本分布';
				showPie(data, 'sdkContainer', title);
			}
		}
	});
}

function showPie(rdata, oDiv, title){
	if(!rdata){
		return;
	}

	//拼装数据
	var point = [], series = [];
	var tmp_item = [];
	for(var i in rdata){
		tmp_item = [];
		tmp_item.push(rdata[i].field_name);
		tmp_item.push(rdata[i].part_num);
		point.push(tmp_item);
	}

	var r_series = {
		type : 'pie',
		name : '占比',
		data : point
	};
	series.push(r_series);
	// console.log(series);
	//画图
	var chart = new Highcharts.Chart({
		chart: {
            type: 'pie',
            renderTo: oDiv,
			style: {
				fontFamily: '"Lucida Grande", "Lucida Sans Unicode","microsoft yahei",Verdana, Arial, Helvetica, sans-serif', 
				fontSize: '12px'
			},
            options3d: {
                enabled: true,
                alpha: 45,
                beta: 0
            }
        },
        title: {
            text: title
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                depth: 35,
                dataLabels: {
                    enabled: true,
                    format: '{point.name}'
                }
            }
        },
        series : series,
        credits:{
			enabled:false
		},
		exporting:{
			enabled:false
		}

	});
}

function showTimeLines(data, oDiv){
	if(!data){
		return;
	}

	var d1=[], s_date=[];

	var style_type = 'line';
	
	var series = [];

	// var data = window.G.common.listSortBy(data, 'datestamp', 'asc');

	for(var i in data){
		s_date.push(data[i].hour_tag);
		d1.push(parseInt(data[i].freq_num));
		// d2.push(parseInt(data[i].active_user));
		// d3.push(parseInt(data[i].new_user));
	}

	var start_item = {
			name: '登录用户数*',
			type: style_type,
			data: d1
		};
	
	series.push(start_item);

	var chart1 = new Highcharts.Chart({
		title:{
			text:"",
			align:"center",
			style:{
				color: '#b5b5b9',
				fontSize:'14px'
			}
		},
		credits:{
			enabled:false
		},
		chart:{
			renderTo: oDiv,
			style: {
				fontFamily: '"Lucida Grande", "Lucida Sans Unicode","microsoft yahei",Verdana, Arial, Helvetica, sans-serif', 
				fontSize: '12px'
			},
			marginRight:100,
			marginTop:60,
			marginLeft:150
		},
		xAxis:{
			categories: s_date,
            lineColor:'#e5e5e5',
            tickColor:'#e5e5e5',
            labels:{
            	style:{
            		color:'#7a7a7a',
            	},
            },
            tickPosition:'inside',
            tickLength:4,
            tickmarkPlacement:'on',
			tickInterval: 1
		},
		yAxis:[{
			labels:{
				format:'{value}',
				formatter: function(){
					return window.G.common.formatInt(0,0,this.value);
				},
				style:{
					color:'#f6505c'
				}
			},
			title:{
				enabled:false
			},
			min: 0
		}],
		legend:{
			align:'center',
			verticalAlign:'top',
			borderWidth:0,
			x:380,
			itemStyle:{
				fontWeight:'normal',
				color:'#a1a8b4'
			},
			itemHoverStyle: {
				color: '#c9c9c9'
			}
		},
		tooltip:{
			shared:false
		},
		series: series,
		plotOptions:{
			line:{
				marker:{
					fillColor: '#FFFFFF',
                    lineWidth: 2,
                    lineColor: null,
                    symbol: 'circle'
				}
			}
		},
		exporting:{
			enabled:false
		}
	})
}

// 用户留存率的区域图
function showArea(data, oDiv){
	// console.log(data);
	// 拼数据
	var s_date = [], series = [];
	var series_3 = [], series_7 = [], series_30 = [];
	for(var i in data){
		s_date.push(data[i].date);
		series_3.push(data[i].retain_3);
		series_7.push(data[i].retain_7);
		series_30.push(data[i].retain_30);
	}

	var item_3 = {
		name : '3天留存',
		data : series_3
	};

	var item_7 = {
		name : '7天留存',
		data : series_7
	};

	var item_30 = {
		name : '30天留存',
		data : series_30
	};

	series.push(item_3);
	series.push(item_7);
	series.push(item_30);

	// console.log(s_date);
	// console.log(series);

	// 画图
    var chart = new Highcharts.Chart({
        chart: {
            type: 'area',
            renderTo: oDiv,
        },
        title: {
            text: '用户留存率'
        },
        // subtitle: {
        //     text: 'Source: thebulletin.metapress.com'
        // },
        xAxis: {
        	categories: s_date,
            // labels: {
            //     formatter: function() {
            //         // return this.value; 
            //     }
            // }
        },
        yAxis: {
            title: {
                text: '用户留存百分比（%）'
            },
            // labels: {
            //     formatter: function() {
            //         return this.value / 1000 +'k';
            //     }
            // }
        },
        tooltip: {
            pointFormat: '{series.name} <b>{point.y:,.1f}%</b><br/>on {point.x}'
        },
        plotOptions: {
            area: {
                // pointStart: 1940,
                marker: {
                    enabled: false,
                    symbol: 'circle',
                    radius: 2,
                    states: {
                        hover: {
                            enabled: true
                        }
                    }
                }
            }
        },
        series: [{
            name: '3天留存',
            data: [33.3, 0.0, 12.0, 15.1, 34.0, 23.6, 0.0
            ]
        },
        {
            name: '7天留存',
            data: [0.0, 12.1, 6.1, 4.3, 23.0, 8.9, 3.1 
            ]
        }, {
            name: '30天留存',
            data: [2.5, 2.2, 3.0, 0.0, 70.0, 34.9, 8.7
            ]
        }]
        // series: series
    });

}


statUserDesc.init();

});
{/literal}
</script>
</body>
</html>
			
			
					