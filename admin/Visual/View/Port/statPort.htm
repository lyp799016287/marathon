<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf8">
<meta content="IE=EmulateIE8" http-equiv="X-UA-Compatible">
<title>接口监控</title>
<link rel="stylesheet" type="text/css" media="all" href="/admin.css" />
<link href="/res/websrc/UIlib/ligerUI-1.1.9/skins/Aqua/css/ligerui-all.css" rel="stylesheet" type="text/css" />
<link href="/res/websrc/css/index.css" rel="stylesheet" type="text/css" />
<link href= "/res/websrc/UIlib/ligerUI-1.1.9/skins/Aqua/css/ligerui-all.css" rel="stylesheet" type="text/css" />
<link href= "/res/websrc/UIlib/ligerUI-1.1.9/skins/ligerui-icons.css" rel="stylesheet" type="text/css" />
<link href= "/res/websrc/UIlib/ligerUI-1.1.9/skins/Gray/css/all.css" rel="stylesheet" type="text/css" />
<script src="/res/websrc/UIlib/jquery/jquery-1.5.2.min.js" type="text/javascript"></script>
<script type="text/javascript" src="/res/js/jquery.cookie.js"></script>
<script type="text/javascript" src="/res/js/loginstatus.js"></script>
<script src="/res/websrc/UIlib/highcharts/highcharts-4.0.3.js" type="text/javascript"></script>
<!--<script src="/res/websrc/UIlib/highcharts/highcharts-3d.js" type="text/javascript"></script>-->
<script src="/res/websrc/UIlib/jquery/common.js" type="text/javascript"></script>
<script src="/res/websrc/UIlib/ligerUI-1.1.9/js/core/base.js" type="text/javascript"></script>
<script src="/res/websrc/UIlib/ligerUI-1.1.9/js/plugins/ligerGrid.js" type="text/javascript" charset="utf-8"></script>
<script src="/res/websrc/UIlib/ligerUI-1.1.9/js/plugins/ligerDialog.js" type="text/javascript" charset="utf-8"></script>
<style type="text/css">
#table_show_options_sum span { width:150px;display: inline-block;}
#table_show_options_details span { /*width:150px;*/display: inline-block;}
#table_filter_div span { width:190px;display: inline-block;} 
#show_item_div span { width:190px;display: inline-block;} 
</style>
</head>
<body>
<div id="left">
	<div id="userinfo">
		<span id='userName'></span>
	</div>
	<nav>
		{include file="$menu_path/menu.htm"}
	</nav>
</div>
	<div class="main" id="main_body">
		<div class="content">
			<div class="inner">
			<div class="cont_bd">
			
			<!-- Start 趋势图 -->
			<div class="mod_list" id="page_sum_table">
				<div class="mod_list_hd org_l">
		        <div class="hd"><h3 id="filter_desc_table">趋势图</h3><span id="date_desc_table" class="sub_tit"></span></div>
				<div id="block_title"></div>
		    	</div>
				<div class="filter filter3" id="table_detail">
					<div class="filter_inner">
						<div>
							<div id="table_show_options_div" class="sel_item">
								<span style="width:640px;">时间单位:
									<select name="zhibiao" id="mix_port_time" style="width:120px;margin-left:10px;">
									<option value="1">天</option>
									<option value="2">周</option>
									<option value="3">月</option>
									</select>
								</span>
							</div>
						</div>
					</div>
					
				</div>
			    <div class="mod_list_bd" style="margin-top:5px;">
			        <div id="stats_content_trend" class="block_content center" style="width:1200px;height:450px;margin-left:50px;"></div>
			    </div>
			</div>
			<!-- End 趋势图 -->

			<!-- Start 详细报表 -->
			<div class="mod_list" id="page_sum_table">
				<div class="mod_list_hd org_l">
					<div class="hd"><h3 id="filter_desc_table">详细报表</h3><span id="date_desc_table" class="sub_tit"></span></div>
		    	</div>
				
			    <div class="mod_list_bd" style="margin-top:5px;">
			        <div id="stats_content_detail" class="block_content center" ></div>
			    </div>
			</div>
			<!-- End 详细报表 -->
			
			<!--指标解释 S-->
			<!-- <div id="terms_definition_div" class="mod_list id_intr">
			    <div class="mod_list_hd">
			        <h3>指标解释</h3>
			    </div>
			    <div class="mod_list_bd" id="term_definition_list">
					<p><strong>活跃用户: </strong>登录用户-新增用户。</p>
			     </div>
			</div> -->
			<!--指标解释 E-->
			</div>
			</div>
		</div>
	</div>
<script>
{literal}
$(document).ready(function(){
	
var statPort = {};

//调用接口
statPort.cgi = {
	// "highlight" : "/Visual/User/totalSummary",
	// "totalData" : "/Visual/User/totalDetail",
	"mixData" : "/Visual/Port/portSummary",
	"detailData": "/Visual/Port/portDetail",
};

statPort.actionHtml = function (){
	// $("#total_user_time").change(statUser.getTotalUser);
	$("#mix_port_time").change(statPort.getMixPort);
}

statPort.init = function (){
	statPort.actionHtml();
	statPort.getMixPort();
	statPort.getDetail();
}


//获取报错数量、接口数量
statPort.getMixPort = function(){
	
	var params = {};
	params['type'] = $("#mix_port_time").val();
	console.log(params['type']);
	$.ajax({
		type : 'POST',
		url : statPort.cgi.mixData,
		dataType : 'json',
		data: '&' + window.G.common.jsonToUrl(params),
		success: function(rdata) {
			console.log(rdata);
			if(rdata.code == 1){
				var data = rdata.data;
				showTimeLines(data, 'stats_content_trend');
			}
		}
	});
}

// 表头 列名称
statPort.header = [
	{
		display: '接口名称',
		name: 'req_url',
		width: '20%',
		isSort: true,
		align: 'center',
		issortshow: true
	},
	{
		display: '请求时间',
		name: 'log_time',
		width: '10%',
		isSort: true,
		align: 'center',
		issortshow: true
	},
	{
		display: '参数列表',
		name: 'req_param',
		width: '15%',
		// type: 'float',
		isSort: false,
		align: 'right',
		//haver效果 
		render:  function (item)
                 {
					return '<a title="'+ item.req_param +'">'+item.req_param+'</a>';
                 },
		issortshow: false
	},
	{
		display: '用户id',
		name: 'req_uid',
		width: '8%',
		type: 'int',
		isSort: true,
		align: 'right',
		render:  window.G.common.formatInt,
		issortshow: true
	},
	{
		display: '接口返回值',
		name: 'resp_str',
		width: '15%',
		// type: 'int',
		isSort: false,
		// render:  window.G.common.formatInt,
		align: 'right',
		issortshow: false
	},
	{
		display: '用户session id',
		name: 'resp_sessionId',
		width: '8%',
		type: 'int',
		isSort: true,
		render:  window.G.common.formatInt,
		align: 'right',
		issortshow: true
	},
	{
		display: '用户session name',
		name: 'resp_sessionName',
		width: '10%',
		// type: 'int',
		isSort: false,
		// render:  window.G.common.formatInt,
		align: 'right',
		issortshow: false
	},
	{
		display: '手机型号',
		name: 'mobile_type',
		width: '8%',
		// type: 'int',
		isSort: false,
		// render:  window.G.common.formatInt,
		align: 'right',
		issortshow: false
	},
	{
		display: '手机系统版本',
		name: 'sys_version',
		width: '8%',
		// type: 'int',
		isSort: true,
		// render:  window.G.common.formatInt,
		align: 'right',
		issortshow: true
	},
	{
		display: 'SDK版本',
		name: 'sys_version',
		width: '8%',
		// type: 'int',
		isSort: true,
		// render:  window.G.common.formatInt,
		align: 'right',
		issortshow: true
	},
	{
		display: 'APP版本',
		name: 'app_version',
		width: '8%',
		// type: 'int',
		isSort: true,
		// render:  window.G.common.formatInt,
		align: 'right',
		issortshow: true
	}
];

// 表格
var gridManager = $("#stats_content_detail").ligerGrid({
	url: statPort.cgi.detailData,
	pageParmName: 'current_page',
	pagesizeParmName: 'page_size',
	sortnameParmName: 'sort_name',
	sortorderParmName: 'sort_order',
	dataAction: 'server',
	dataType: 'json',
	root: 'data',
	record: 'Total',
	method: 'post',
	pageSize: 20,
	pageSizeOptions: [10, 20, 50, 100, 150],
	delayLoad: true,
	onLoading: function() {
		//$.ligerDialog.waitting('根据数据量情况,加载时间不定,请稍等...');
	},
	onAfterShowData: function() {
		//$.ligerDialog.closeWaitting();
	},
});


// 表格数据
statPort.getDetail = function(){

	gridManager.setOptions({columns: statPort.header});
	// gridManager.setOptions({parms: params});
	gridManager.loadData();
}

// 折线图展示
function showTimeLines(data, oDiv){
	if(!data){
		return;
	}

	// var d1=[], d2=[], d3=[], s_date=[];
	var d1=[], d2=[], s_date=[];

	var style_type = 'line';
	
	var series = [];

	var data = window.G.common.listSortBy(data, 'datestamp', 'asc');

	for(var i in data){
		s_date.push(data[i].datestamp);
		d1.push(parseInt(data[i].error_num));
		d2.push(parseInt(data[i].port_num));
		// d3.push(parseInt(data[i].new_user));
	}

	/*console.log(d1);
	console.log(d2);
	console.log(d3);*/

	var start_item = {
			name: '报错数量',
			type:style_type,
			data: d1
		};
	
	series.push(start_item);

	var second_item = {
		name: '报错的接口数量',
		type:style_type,
		data: d2
	}
	series.push(second_item);

	var chart1 = new Highcharts.Chart({
		title:{
			text:"",
			align:"center",
			style:{
				color: '#b5b5b9',
				fontSize:'14px'
			}
		},
		credits:{
			enabled:false
		},
		chart:{
			renderTo: oDiv,
			style: {
				fontFamily: '"Lucida Grande", "Lucida Sans Unicode","microsoft yahei",Verdana, Arial, Helvetica, sans-serif', 
				fontSize: '12px'
			},
			marginRight:100,
			marginTop:60,
			marginLeft:150
		},
		xAxis:{
			categories: s_date,
            lineColor:'#e5e5e5',
            tickColor:'#e5e5e5',
            labels:{
            	style:{
            		color:'#7a7a7a',
            	},
            },
            tickPosition:'inside',
            tickLength:4,
            tickmarkPlacement:'on',
			tickInterval: 1
		},
		yAxis:[{
			labels:{
				format:'{value}',
				formatter: function(){
					return window.G.common.formatInt(0,0,this.value);
				},
				style:{
					color:'#f6505c'
				}
			},
			title:{
				enabled:false
			},
			min: 0
		}],
		legend:{
			align:'center',
			verticalAlign:'top',
			borderWidth:0,
			x:380,
			itemStyle:{
				fontWeight:'normal',
				color:'#a1a8b4'
			},
			itemHoverStyle: {
				color: '#c9c9c9'
			}
		},
		tooltip:{
			shared:false
		},
		series: series,
		plotOptions:{
			line:{
				marker:{
					fillColor: '#FFFFFF',
                    lineWidth: 2,
                    lineColor: null,
                    symbol: 'circle'
				}
			}
		},
		exporting:{
			enabled:false
		}
	})
}


statPort.init();

});
{/literal}
</script>
</body>
</html>
			
			
					